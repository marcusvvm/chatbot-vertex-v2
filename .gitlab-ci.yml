stages:
  - deploy

# Seta as vari√°veis com os dados do ambiente que est√° sendo feita a atualiza√ß√£o do projeto
workflow:
  rules:
    - if: ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main' || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_REF_NAME == "main")
      variables:
        DEPLOY_VAR: 'producao'
        BRANCH_VAR: 'main'
    - if: ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "homol" || $CI_COMMIT_BRANCH == "homol" || $CI_COMMIT_REF_NAME == "homol")
      variables:
        DEPLOY_VAR: 'homologacao'
        BRANCH_VAR: 'homol'

# Seta as vari√°veis para uso no script
variables:
  PROJETO_DIR: '/var/www/html/$CI_PROJECT_NAME'
  GIT_REMOTE: 'git@gitlab.crea-go.org.br:ia/bia/bia-back.git'

# Script para atualiza√ß√£o do projeto
implanta-app:
  stage: deploy
  tags:
    # Tags configuradas nos runners
    - $DEPLOY_VAR
  only:
    # Branches que est√£o escutando as atualiza√ß√µes para sincroniza√ß√£o com os respectivos runners
    - main
    - homol
  script:
    # Print vari√°veis GitLab CI
    - echo "CI_COMMIT_BRANCH= $CI_COMMIT_BRANCH"
    - echo "CI_COMMIT_REF_NAME= $CI_COMMIT_REF_NAME"
    - echo "CI_MERGE_REQUEST_TARGET_BRANCH_NAME= $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - echo "CI_MERGE_REQUEST_SOURCE_BRANCH_NAME= $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    # Print vari√°veis
    - echo "BRANCH_VAR= $BRANCH_VAR"
    #- cd /var/www/html/repositorios
    - cd /var/www/html
    # Verificar se o diret√≥rio com o nome do projeto existe
    - |
      if [ -d "$PROJETO_DIR" ]; then
          echo "O diret√≥rio existe"
          cd "$PROJETO_DIR"
          git branch | grep $BRANCH_VAR
          BRANCH_EXISTE=$(echo $?)
          if [ $BRANCH_EXISTE -eq 0 ]; then
              git fetch
              git pull origin $BRANCH_VAR
          fi
      else
          echo "Diret√≥rio n√£o existe..."
          git clone -b $BRANCH_VAR --single-branch $GIT_REMOTE $CI_PROJECT_NAME
      fi
after_script:
  # Executa ap√≥s script de atualiza√ß√£o do projeto (Python/FastAPI)
  - |
    if [ -d "$PROJETO_DIR" ]; then
        echo "=========================================="
        echo "üöÄ DEPLOY BIA-BACK (Python/FastAPI)"
        echo "=========================================="
        cd "$PROJETO_DIR"

        echo "üìÅ Diret√≥rio: $(pwd)"
        echo "üë§ Usu√°rio: $(whoami)"
        echo "üêç Python: $(python3 --version)"

        # Criar diret√≥rio de logs local
        mkdir -p logs

        # Recriar ambiente virtual para garantir compatibilidade
        echo ""
        echo "üì¶ Configurando ambiente virtual..."
        if [ -d "venv" ]; then
            echo "Removendo venv antigo para garantir compatibilidade..."
            rm -rf venv
        fi
        echo "Criando novo ambiente virtual..."
        python3 -m venv venv

        # Ativar venv e instalar depend√™ncias
        echo ""
        echo "üì• Instalando depend√™ncias..."
        source venv/bin/activate
        pip install --upgrade pip --quiet
        pip install -r requirements.txt
        echo "‚úÖ Depend√™ncias instaladas!"

        # Verificar se .env existe e carregar vari√°veis
        echo ""
        echo "üîç Verificando configura√ß√£o..."
        if [ -f ".env" ]; then
            echo "‚úÖ Arquivo .env encontrado"
            export $(grep -v '^#' .env | xargs)
        else
            echo "‚ö†Ô∏è  AVISO: Arquivo .env N√ÉO encontrado!"
            echo "   Copie .env.example para .env e configure"
        fi

        # Definir porta (fallback para 8000)
        PORT=${PORT:-8000}
        echo "üìç Porta configurada: $PORT"

        # Verificar se credenciais existem
        if [ -f "credentials/credentials-rag.json" ]; then
            echo "‚úÖ Credenciais GCP encontradas"
        else
            echo "‚ö†Ô∏è  AVISO: Credenciais GCP N√ÉO encontradas!"
        fi

        # Parar processo gunicorn existente (se houver)
        echo ""
        echo "üîÑ Reiniciando servidor..."
        pkill -f "gunicorn app.main:app" || true
        sleep 2

        # Verificar porta dispon√≠vel
        if lsof -i :$PORT > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Porta $PORT em uso. Matando processos..."
            fuser -k $PORT/tcp || true
            sleep 2
        fi

        # Iniciar gunicorn em background com logs locais
        echo ""
        echo "üöÄ Iniciando Gunicorn..."
        echo "Comando: ./venv/bin/gunicorn app.main:app --workers 4 --bind 0.0.0.0:$PORT"
        
        ./venv/bin/gunicorn app.main:app \
            --workers 4 \
            --worker-class uvicorn.workers.UvicornWorker \
            --bind 0.0.0.0:$PORT \
            --timeout 120 \
            --access-logfile logs/access.log \
            --error-logfile logs/error.log \
            --capture-output \
            --pid logs/gunicorn.pid \
            --daemon

        sleep 5

        # Mostrar logs de erro se existirem
        echo ""
        echo "üìã Logs de inicializa√ß√£o:"
        if [ -f "logs/error.log" ]; then
            cat logs/error.log
        fi
        if [ -f "logs/startup.log" ]; then
            cat logs/startup.log
        fi

        # Verificar se o servidor iniciou
        echo ""
        if pgrep -f "gunicorn app.main:app" > /dev/null; then
            echo "‚úÖ Servidor Gunicorn iniciado com sucesso!"
            echo "üìç Endpoint: http://localhost:8000"
            echo "üìã Logs: $PROJETO_DIR/logs/"
        else
            echo "‚ùå Falha ao iniciar o servidor!"
            echo ""
            echo "üîç Diagn√≥stico:"
            echo "Processos Python:"
            ps aux | grep -E "(python|gunicorn)" | grep -v grep || echo "Nenhum processo Python encontrado"
            echo ""
            echo "Porta 8000:"
            lsof -i :8000 || echo "Porta 8000 dispon√≠vel"
            echo ""
            echo "√öltimas linhas do log de erro:"
            tail -20 logs/error.log 2>/dev/null || echo "Sem logs de erro"
            exit 1
        fi

        echo ""
        echo "=========================================="
        echo "üéâ DEPLOY FINALIZADO COM SUCESSO!"
        echo "=========================================="
    else
        echo "‚ùå Diret√≥rio $PROJETO_DIR n√£o existe!"
        exit 1
    fi