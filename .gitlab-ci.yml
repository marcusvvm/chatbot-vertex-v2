stages:
  - deploy

# Seta as vari√°veis com os dados do ambiente que est√° sendo feita a atualiza√ß√£o do projeto
workflow:
  rules:
    - if: ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main' || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_REF_NAME == "main")
      variables:
        DEPLOY_VAR: 'producao'
        BRANCH_VAR: 'main'
    - if: ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "homol" || $CI_COMMIT_BRANCH == "homol" || $CI_COMMIT_REF_NAME == "homol")
      variables:
        DEPLOY_VAR: 'homologacao'
        BRANCH_VAR: 'homol'

# Seta as vari√°veis para uso no script
variables:
  PROJETO_DIR: '/var/www/html/$CI_PROJECT_NAME'
  GIT_REMOTE: 'git@gitlab.crea-go.org.br:ia/bia/bia-back.git'

# Script para atualiza√ß√£o do projeto
implanta-app:
  stage: deploy
  tags:
    # Tags configuradas nos runners
    - $DEPLOY_VAR
  only:
    # Branches que est√£o escutando as atualiza√ß√µes para sincroniza√ß√£o com os respectivos runners
    - main
    - homol
  script:
    # Print vari√°veis GitLab CI
    - echo "CI_COMMIT_BRANCH= $CI_COMMIT_BRANCH"
    - echo "CI_COMMIT_REF_NAME= $CI_COMMIT_REF_NAME"
    - echo "CI_MERGE_REQUEST_TARGET_BRANCH_NAME= $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - echo "CI_MERGE_REQUEST_SOURCE_BRANCH_NAME= $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    # Print vari√°veis
    - echo "BRANCH_VAR= $BRANCH_VAR"
    #- cd /var/www/html/repositorios
    - cd /var/www/html
    # Verificar se o diret√≥rio com o nome do projeto existe
    - |
      if [ -d "$PROJETO_DIR" ]; then
          echo "O diret√≥rio existe"
          cd "$PROJETO_DIR"
          git branch | grep $BRANCH_VAR
          BRANCH_EXISTE=$(echo $?)
          if [ $BRANCH_EXISTE -eq 0 ]; then
              git fetch
              git pull origin $BRANCH_VAR
          fi
      else
          echo "Diret√≥rio n√£o existe..."
          git clone -b $BRANCH_VAR --single-branch $GIT_REMOTE $CI_PROJECT_NAME
      fi
after_script:
  # Executa ap√≥s script de atualiza√ß√£o do projeto (Python/FastAPI)
  - |
    if [ -d "$PROJETO_DIR" ]; then
        echo "=========================================="
        echo "üöÄ DEPLOY BIA-BACK (Python/FastAPI)"
        echo "=========================================="
        cd "$PROJETO_DIR"

        echo "üìÅ Diret√≥rio: $(pwd)"
        echo "üë§ Usu√°rio: $(whoami)"
        echo "üêç Python: $(python3 --version)"

        # Recriar ambiente virtual para garantir compatibilidade
        echo ""
        echo "üì¶ Configurando ambiente virtual..."
        if [ -d "venv" ]; then
            echo "Removendo venv antigo para garantir compatibilidade..."
            rm -rf venv
        fi
        echo "Criando novo ambiente virtual..."
        python3 -m venv venv

        # Ativar venv e instalar depend√™ncias
        echo ""
        echo "üì• Instalando depend√™ncias..."
        source venv/bin/activate
        pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet
        echo "‚úÖ Depend√™ncias instaladas!"

        # Parar processo gunicorn existente (se houver)
        echo ""
        echo "üîÑ Reiniciando servidor..."
        pkill -f "gunicorn app.main:app" || true
        sleep 2

        # Iniciar gunicorn em background
        echo "Iniciando Gunicorn..."
        nohup ./venv/bin/gunicorn app.main:app \
            --workers 4 \
            --worker-class uvicorn.workers.UvicornWorker \
            --bind 0.0.0.0:8000 \
            --timeout 120 \
            --access-logfile /var/log/bia-back-access.log \
            --error-logfile /var/log/bia-back-error.log \
            --daemon

        sleep 3

        # Verificar se o servidor iniciou
        if pgrep -f "gunicorn app.main:app" > /dev/null; then
            echo "‚úÖ Servidor Gunicorn iniciado com sucesso!"
            echo "üìç Endpoint: http://localhost:8000"
            echo "üìã Logs: /var/log/bia-back-*.log"
        else
            echo "‚ùå Falha ao iniciar o servidor!"
            exit 1
        fi

        echo ""
        echo "=========================================="
        echo "üéâ DEPLOY FINALIZADO COM SUCESSO!"
        echo "=========================================="
    else
        echo "‚ùå Diret√≥rio $PROJETO_DIR n√£o existe!"
        exit 1
    fi